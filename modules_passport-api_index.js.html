<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>modules/passport-api/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="nav">
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-Configs.html">Configs</a></li><li><a href="tutorial-Importing Accounts.html">Importing Accounts</a></li><li><a href="tutorial-Setup Error Monitoring.html">Setup Error Monitoring</a></li><li><a href="tutorial-Web App System Requirements.html">Web App System Requirements</a></li></ul><h3>API</h3><ul><li><a href="#">/api/account/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~searchAccounts">GET</a></li></ul></li><li><a href="#">/api/account/email/:email/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getAccountsByEmail">GET</a></li></ul></li><li><a href="#">/api/account/groupfields/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleUpdateAccountGroupFieldsByUser">PATCH</a></li></ul></li><li><a href="#">/api/account/hasClasses</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getAccountsWithClasses">GET</a></li></ul></li><li><a href="#">/api/account/id/:id</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsById">GET</a></li></ul></li><li><a href="#">/api/account/incomplete/dashboard/student</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~studentCheckIfIncomplete">GET</a></li></ul></li><li><a href="#">/api/account/location/datetime/:dateTime/id/:id/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getCurrentLocation">GET</a></li></ul></li><li><a href="#">/api/account/name/:name/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByName">GET</a></li></ul></li><li><a href="#">/api/account/new/:userGroup/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleNewAccount">POST</a></li></ul></li><li><a href="#">/api/account/password/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~updateUserPassword">PATCH</a></li></ul></li><li><a href="#">/api/account/schedule/:dashboard</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~setUserSchedule">POST</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">PATCH</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">PUT</a></li></ul></li><li><a href="#">/api/account/schedule/[:id]</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getAllSchedules">GET</a></li></ul></li><li><a href="#">/api/account/schedule/student/:id</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForStudentDash">GET</a></li></ul></li><li><a href="#">/api/account/schedule/teacher/:id</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForTeacherDash">GET</a></li></ul></li><li><a href="#">/api/account/userGroup/:userGroup/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByUserGroup">GET</a></li></ul></li><li><a href="#">/api/account/userGroup/:userGroup/name/:name/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByNameAndUserGroup">GET</a></li></ul></li><li><a href="#">/api/auth/login/</a><ul class='methods'><li data-type='method'><a href="module-authRESTAPI.html#~handleAuthLogin">POST</a></li></ul></li><li><a href="#">/api/auth/login/dscm</a><ul class='methods'><li data-type='method'><a href="module-authRESTAPI.html#~loginDSCM">POST</a></li></ul></li><li><a href="#">/api/blackout/</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~newBlackout">POST</a></li></ul></li><li><a href="#">/api/blackout/date/:date</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByDate">POST</a></li></ul></li><li><a href="#">/api/blackout/user/:userId</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserId">POST</a></li></ul></li><li><a href="#">/api/blackout/user/:userId/date/:date</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserIdAndDate">POST</a></li></ul></li><li><a href="#">/api/import/accounts</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~importJsonAccounts">POST</a></li></ul></li><li><a href="#">/api/import/accounts/:bulkID/activate</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~activate">POST</a></li></ul></li><li><a href="#">/api/import/accounts/:bulkID/rollback</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~rollback">DELETE</a></li></ul></li><li><a href="#">/api/import/log</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~searchBulkImport">GET</a></li></ul></li><li><a href="#">/api/media/avatar/:id/:size.svg</a><ul class='methods'><li data-type='method'><a href="module-mediaRESTAPI.html#~getIdenticon">GET</a></li></ul></li><li><a href="#">/api/media/background/:id.svg</a><ul class='methods'><li data-type='method'><a href="module-mediaRESTAPI.html#~generateBackdrop">GET</a></li></ul></li><li><a href="#">/api/passes/me/</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~newPassForMe">POST</a></li></ul></li><li><a href="#">/api/passes/me/by/:idCol/from/:fromDay/</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromDay">GET</a></li></ul></li><li><a href="#">/api/passes/me/by/:idCol/from/:fromDay/to/:toDay</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromToDay">GET</a></li></ul></li><li><a href="#">/api/passes/status/:passId/isMigrating/:state</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~updateMigrationStatus">PATCH</a></li></ul></li><li><a href="#">/api/passes/status/:passId/state/:state</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~updatePassState">PATCH</a></li></ul></li><li><a href="#">/api/security/key/:type</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~getPermissionKeyData">GET</a></li></ul></li><li><a href="#">/api/security/key/API/</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~handleNewApiKey">POST</a></li></ul></li><li><a href="#">/api/security/key/NEW_ACCOUNT/</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~handleCreatePermissionKey">POST</a></li></ul></li><li><a href="#">/api/server/config/passGroup/</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~handleGetAccountsByName">GET</a></li></ul></li><li><a href="#">/api/server/config/schedule/</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~getScheduleConstants">GET</a></li></ul></li><li><a href="#">/api/server/config/userGroups/</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~getUserGroups">GET</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api_accounts.html">api/accounts</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getAccountsByEmail">getAccountsByEmail</a></li><li data-type='method'><a href="module-api_accounts.html#~getAccountsWithClasses">getAccountsWithClasses</a></li><li data-type='method'><a href="module-api_accounts.html#~getCurrentLocation">getCurrentLocation</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsById">handleGetAccountsById</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByName">handleGetAccountsByName</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByNameAndUserGroup">handleGetAccountsByNameAndUserGroup</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByUserGroup">handleGetAccountsByUserGroup</a></li><li data-type='method'><a href="module-api_accounts.html#~handleNewAccount">handleNewAccount</a></li><li data-type='method'><a href="module-api_accounts.html#~handleUpdateAccountGroupFieldsByUser">handleUpdateAccountGroupFieldsByUser</a></li><li data-type='method'><a href="module-api_accounts.html#~searchAccounts">searchAccounts</a></li><li data-type='method'><a href="module-api_accounts.html#~studentCheckIfIncomplete">studentCheckIfIncomplete</a></li><li data-type='method'><a href="module-api_accounts.html#~updateUserPassword">updateUserPassword</a></li></ul></li><li><a href="module-api_import.html">api/import</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~activate">activate</a></li><li data-type='method'><a href="module-api_import.html#~importJsonAccounts">importJsonAccounts</a></li><li data-type='method'><a href="module-api_import.html#~rollback">rollback</a></li><li data-type='method'><a href="module-api_import.html#~searchBulkImport">searchBulkImport</a></li></ul></li><li><a href="module-api_userSchedule.html">api/userSchedule</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getAllSchedules">getAllSchedules</a></li><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForStudentDash">getSchedulesForStudentDash</a></li><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForTeacherDash">getSchedulesForTeacherDash</a></li><li data-type='method'><a href="module-api_userSchedule.html#~setUserSchedule">setUserSchedule</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">updateUserSchedule</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">updateUserSchedule</a></li></ul></li><li><a href="module-apiRoute.html">apiRoute</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~getScheduleConstants">getScheduleConstants</a></li><li data-type='method'><a href="module-apiRoute.html#~getUserGroups">getUserGroups</a></li><li data-type='method'><a href="module-apiRoute.html#~handleAuthLogin">handleAuthLogin</a></li><li data-type='method'><a href="module-apiRoute.html#~handleGetAccountsByName">handleGetAccountsByName</a></li></ul></li><li><a href="module-authRESTAPI.html">authRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-authRESTAPI.html#~handleAuthLogin">handleAuthLogin</a></li><li data-type='method'><a href="module-authRESTAPI.html#~loginDSCM">loginDSCM</a></li></ul></li><li><a href="module-blackoutAPI.html">blackoutAPI</a></li><li><a href="module-blackoutRESTAPI.html">blackoutRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByDate">getBlackoutByDate</a></li><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserId">getBlackoutByUserId</a></li><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserIdAndDate">getBlackoutByUserIdAndDate</a></li><li data-type='method'><a href="module-blackoutRESTAPI.html#~newBlackout">newBlackout</a></li></ul></li><li><a href="module-js_accounts.html">js/accounts</a><ul class='methods'><li data-type='method'><a href="module-js_accounts.html#.get">get</a></li><li data-type='method'><a href="module-js_accounts.html#.newUserSchedule">newUserSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#.replaceUserSchedule">replaceUserSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#.updateUserSchedule">updateUserSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#~changePassword">changePassword</a></li><li data-type='method'><a href="module-js_accounts.html#~createAccount">createAccount</a></li><li data-type='method'><a href="module-js_accounts.html#~getAccountByEmail">getAccountByEmail</a></li><li data-type='method'><a href="module-js_accounts.html#~getSpecificPeriods">getSpecificPeriods</a></li><li data-type='method'><a href="module-js_accounts.html#~getStudentSchedule">getStudentSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#~getTeacherSchedule">getTeacherSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#~getUserByID">getUserByID</a></li><li data-type='method'><a href="module-js_accounts.html#~getUserGroupAccountByName">getUserGroupAccountByName</a></li><li data-type='method'><a href="module-js_accounts.html#~getUserGroupAccountByUserGroup">getUserGroupAccountByUserGroup</a></li><li data-type='method'><a href="module-js_accounts.html#~setVerification">setVerification</a></li><li data-type='method'><a href="module-js_accounts.html#~updateAccountGroupFieldsByID">updateAccountGroupFieldsByID</a></li><li data-type='method'><a href="module-js_accounts.html#~updatePassword">updatePassword</a></li><li data-type='method'><a href="module-js_accounts.html#~updateTags">updateTags</a></li><li data-type='method'><a href="module-js_accounts.html#~verifyPassword">verifyPassword</a></li></ul></li><li><a href="module-js_email.html">js/email</a><ul class='methods'><li data-type='method'><a href="module-js_email.html#~sendActivationEmail">sendActivationEmail</a></li><li data-type='method'><a href="module-js_email.html#~sendMail">sendMail</a></li><li data-type='method'><a href="module-js_email.html#~sendResetPasswordEmail">sendResetPasswordEmail</a></li></ul></li><li><a href="module-js_emailTemplates.html">js/emailTemplates</a></li><li><a href="module-js_import.html">js/import</a><ul class='methods'><li data-type='method'><a href="module-js_import.html#~deleteBulkLog">deleteBulkLog</a></li><li data-type='method'><a href="module-js_import.html#~importAccountsExcel">importAccountsExcel</a></li><li data-type='method'><a href="module-js_import.html#~mapAccounts">mapAccounts</a></li><li data-type='method'><a href="module-js_import.html#~newBulkLog">newBulkLog</a></li><li data-type='method'><a href="module-js_import.html#~updateBulkLog">updateBulkLog</a></li></ul></li><li><a href="module-js_passes.html">js/passes</a><ul class='methods'><li data-type='method'><a href="module-js_passes.html#.flexableGetPasses">flexableGetPasses</a></li><li data-type='method'><a href="module-js_passes.html#.getPass">getPass</a></li><li data-type='method'><a href="module-js_passes.html#.limitTally">limitTally</a></li><li data-type='method'><a href="module-js_passes.html#.newPass">newPass</a></li><li data-type='method'><a href="module-js_passes.html#.updatePass">updatePass</a></li></ul></li><li><a href="module-js_schedules.html">js/schedules</a><ul class='methods'><li data-type='method'><a href="module-js_schedules.html#~getActivePeriodsAtDateTime">getActivePeriodsAtDateTime</a></li></ul></li><li><a href="module-js_security.html">js/security</a><ul class='methods'><li data-type='method'><a href="module-js_security.html#.checkPermissionKey">checkPermissionKey</a></li><li data-type='method'><a href="module-js_security.html#.checkPermissionKeyValidity">checkPermissionKeyValidity</a></li><li data-type='method'><a href="module-js_security.html#.cleanDB">cleanDB</a></li><li data-type='method'><a href="module-js_security.html#.createPermissionKey">createPermissionKey</a></li><li data-type='method'><a href="module-js_security.html#.getPermissionKeyData">getPermissionKeyData</a></li><li data-type='method'><a href="module-js_security.html#.keyUsed">keyUsed</a></li><li data-type='method'><a href="module-js_security.html#.newKey.activateAccount">newKey.activateAccount</a></li><li data-type='method'><a href="module-js_security.html#.newKey.newAccount">newKey.newAccount</a></li><li data-type='method'><a href="module-js_security.html#.newKey.resetPassword">newKey.resetPassword</a></li></ul></li><li><a href="module-js_userSchedule.html">js/userSchedule</a><ul class='methods'><li data-type='method'><a href="module-js_userSchedule.html#.get">get</a></li><li data-type='method'><a href="module-js_userSchedule.html#.getStudentSchedule">getStudentSchedule</a></li><li data-type='method'><a href="module-js_userSchedule.html#.getTeacherSchedule">getTeacherSchedule</a></li><li data-type='method'><a href="module-js_userSchedule.html#.new">new</a></li><li data-type='method'><a href="module-js_userSchedule.html#.replace">replace</a></li><li data-type='method'><a href="module-js_userSchedule.html#.update">update</a></li></ul></li><li><a href="module-js_utils.html">js/utils</a><ul class='methods'><li data-type='method'><a href="module-js_utils.html#.checkPermission">checkPermission</a></li><li data-type='method'><a href="module-js_utils.html#.compileDashboardNav">compileDashboardNav</a></li><li data-type='method'><a href="module-js_utils.html#.getAllowedDashboards">getAllowedDashboards</a></li><li data-type='method'><a href="module-js_utils.html#.middlewarePermission">middlewarePermission</a></li><li data-type='method'><a href="module-js_utils.html#.urlQuery">urlQuery</a></li><li data-type='method'><a href="module-js_utils.html#~checkPasswordPolicy">checkPasswordPolicy</a></li><li data-type='method'><a href="module-js_utils.html#~checkPeriod">checkPeriod</a></li><li data-type='method'><a href="module-js_utils.html#~cleanUser">cleanUser</a></li><li data-type='method'><a href="module-js_utils.html#~dscm">dscm</a></li><li data-type='method'><a href="module-js_utils.html#~generateSecureKey">generateSecureKey</a></li><li data-type='method'><a href="module-js_utils.html#~getBrowserSupport">getBrowserSupport</a></li></ul></li><li><a href="module-js_utils_rateLimit.html">js/utils/rateLimit</a><ul class='methods'><li data-type='method'><a href="module-js_utils_rateLimit.html#~emailPasswordResetBruteforce">emailPasswordResetBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~emailPasswordResetBruteforce">emailPasswordResetBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~emailPasswordResetBruteforce">emailPasswordResetBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~loginBruteforce">loginBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~loginBruteforce">loginBruteforce</a></li></ul></li><li><a href="module-mediaRESTAPI.html">mediaRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-mediaRESTAPI.html#~generateBackdrop">generateBackdrop</a></li><li data-type='method'><a href="module-mediaRESTAPI.html#~getIdenticon">getIdenticon</a></li></ul></li><li><a href="module-miscRESTApi.html">miscRESTApi</a></li><li><a href="module-passportApi.html">passportApi</a><ul class='methods'><li data-type='method'><a href="module-passportApi.html#~getPassGroups">getPassGroups</a></li><li data-type='method'><a href="module-passportApi.html#~getScheduleDefinition">getScheduleDefinition</a></li><li data-type='method'><a href="module-passportApi.html#~getScheduleOfADate">getScheduleOfADate</a></li><li data-type='method'><a href="module-passportApi.html#~newScheduleDefinition">newScheduleDefinition</a></li><li data-type='method'><a href="module-passportApi.html#~scheduleRepeatingScheduleDefinition">scheduleRepeatingScheduleDefinition</a></li><li data-type='method'><a href="module-passportApi.html#~scheduleSingleScheduleDefinition">scheduleSingleScheduleDefinition</a></li></ul></li><li><a href="module-passportAuthApi.html">passportAuthApi</a><ul class='methods'><li data-type='method'><a href="module-passportAuthApi.html#~newJWT">newJWT</a></li><li data-type='method'><a href="module-passportAuthApi.html#~newJWTForCookies">newJWTForCookies</a></li></ul></li><li><a href="module-passRESTApi.html">passRESTApi</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromDay">getPassForMeFromDay</a></li><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromToDay">getPassForMeFromToDay</a></li><li data-type='method'><a href="module-passRESTApi.html#~newPassForMe">newPassForMe</a></li><li data-type='method'><a href="module-passRESTApi.html#~updateArrivedStatus">updateArrivedStatus</a></li><li data-type='method'><a href="module-passRESTApi.html#~updateMigrationStatus">updateMigrationStatus</a></li><li data-type='method'><a href="module-passRESTApi.html#~updatePassState">updatePassState</a></li></ul></li><li><a href="module-securityRESTAPI.html">securityRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~getPermissionKeyData">getPermissionKeyData</a></li><li data-type='method'><a href="module-securityRESTAPI.html#~handleCreatePermissionKey">handleCreatePermissionKey</a></li><li data-type='method'><a href="module-securityRESTAPI.html#~handleNewApiKey">handleNewApiKey</a></li></ul></li><li><a href="module-webpack_api_accounts.html">webpack/api/accounts</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_accounts.html#.get">get</a></li><li data-type='method'><a href="module-webpack_api_accounts.html#.getWithClasses">getWithClasses</a></li></ul></li><li><a href="module-webpack_api_import.html">webpack/api/import</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_import.html#.accounts">accounts</a></li><li data-type='method'><a href="module-webpack_api_import.html#.searchBulkLogs">searchBulkLogs</a></li></ul></li><li><a href="module-webpack_api_misc.html">webpack/api/misc</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_misc.html#.getScheduleConfig">getScheduleConfig</a></li><li data-type='method'><a href="module-webpack_api_misc.html#.getUserGroups">getUserGroups</a></li></ul></li><li><a href="module-webpack_api_schedule.html">webpack/api/schedule</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_schedule.html#.getSchedules">getSchedules</a></li><li data-type='method'><a href="module-webpack_api_schedule.html#.newSchedule">newSchedule</a></li><li data-type='method'><a href="module-webpack_api_schedule.html#.replaceSchedule">replaceSchedule</a></li><li data-type='method'><a href="module-webpack_api_schedule.html#.updateSchedule">updateSchedule</a></li></ul></li><li><a href="module-webpack_api_security.html">webpack/api/security</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_security.html#.newAccount">newAccount</a></li></ul></li><li><a href="module-webpack_buttonLoader.html">webpack/buttonLoader</a><ul class='methods'><li data-type='method'><a href="module-webpack_buttonLoader.html#.done">done</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.fail">fail</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.load">load</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.success">success</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.warning">warning</a></li></ul></li><li><a href="module-webpack_unsavedWork.html">webpack/unsavedWork</a><ul class='methods'><li data-type='method'><a href="module-webpack_unsavedWork.html#.button">button</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.changed">changed</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.destroy">destroy</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.reset">reset</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.saved">saved</a></li></ul></li><li><a href="module-webpack_utils.html">webpack/utils</a><ul class='methods'><li data-type='method'><a href="module-webpack_utils.html#.closePage">closePage</a></li><li data-type='method'><a href="module-webpack_utils.html#.distinctKeys">distinctKeys</a></li><li data-type='method'><a href="module-webpack_utils.html#.fetch">fetch</a></li><li data-type='method'><a href="module-webpack_utils.html#.fetchJSON">fetchJSON</a></li><li data-type='method'><a href="module-webpack_utils.html#.fetchStatus">fetchStatus</a></li><li data-type='method'><a href="module-webpack_utils.html#.formatJSON">formatJSON</a></li><li data-type='method'><a href="module-webpack_utils.html#.getCookie">getCookie</a></li><li data-type='method'><a href="module-webpack_utils.html#.loader">loader</a></li><li data-type='method'><a href="module-webpack_utils.html#.materialResponse">materialResponse</a></li><li data-type='method'><a href="module-webpack_utils.html#.openPage">openPage</a></li><li data-type='method'><a href="module-webpack_utils.html#.setCookie">setCookie</a></li><li data-type='method'><a href="module-webpack_utils.html#.thisUser">thisUser</a></li><li data-type='method'><a href="module-webpack_utils.html#.throwError">throwError</a></li><li data-type='method'><a href="module-webpack_utils.html#.urlQuery">urlQuery</a></li><li data-type='method'><a href="module-webpack_utils.html#.uuidv4">uuidv4</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="Caret.html">Caret</a><ul class='methods'><li data-type='method'><a href="Caret.html#destroy">destroy</a></li><li data-type='method'><a href="Caret.html#initialize">initialize</a></li><li data-type='method'><a href="Caret.html#toggle">toggle</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#debug">debug</a></li><li data-type='method'><a href="Logger.html#done">done</a></li><li data-type='method'><a href="Logger.html#error">error</a></li><li data-type='method'><a href="Logger.html#fetchError">fetchError</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#warn">warn</a></li><li data-type='method'><a href="Logger.html#working">working</a></li></ul></li><li><a href="StudentScheduleEditor.html">StudentScheduleEditor</a><ul class='methods'><li data-type='method'><a href="StudentScheduleEditor.html#checkValidity">checkValidity</a></li><li data-type='method'><a href="StudentScheduleEditor.html#generate">generate</a></li><li data-type='method'><a href="StudentScheduleEditor.html#getHasChanged">getHasChanged</a></li><li data-type='method'><a href="StudentScheduleEditor.html#submit">submit</a></li></ul></li><li><a href="Table.html">Table</a></li><li><a href="TeacherScheduleEditor.html">TeacherScheduleEditor</a><ul class='methods'><li data-type='method'><a href="TeacherScheduleEditor.html#checkValidity">checkValidity</a></li><li data-type='method'><a href="TeacherScheduleEditor.html#generate">generate</a></li><li data-type='method'><a href="TeacherScheduleEditor.html#getHasChanged">getHasChanged</a></li><li data-type='method'><a href="TeacherScheduleEditor.html#submit">submit</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/passport-api/index.js</h1>
    

    <!--container.tmpl-->




    <!--source.tmpl-->

    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
Passport-Live is a modern web app for schools that helps them manage passes.
    Copyright (C) 2017  Joseph Hassell

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/>.

email: hi@josephhassell.com
*/

var r = require('rethinkdb');
var shortid = require('shortid');
var utils = require('../passport-utils/index.js');
var moment = require('moment');
var config = require('config');
var securityAPI = require("./security.js");
//All functions that make the api function.
/** 
* @module passportApi 
* @example
* var api = require('./modules/passport-api/index.js')
*/
module.exports = { 
    
    /** 
    ADMINISTRATION
    **/

    /** 
    * Creates a new Schedule Definition
    * @function newScheduleDefinition
    * @link module:passportApi
    * @async
    * @returns {callback} error and Rethinkdb action sum
    * @param {object} dbConn - RethinkDB Connection Object.
    * @param {string} name - Name of the Schedule
    * @param {scheduleData} scheduleData - See: {@link #params-scheduleData|&lt;a href="#params-scheduleData">Tree Example&lt;/a>}
    * @param {function} done - Callback
    */
    newScheduleDefinition: function(dbConn, name, scheduleData, done) {
        //check if times are in correct spots 
        var allowedPer = config.get('schedule.periods');
        //loop through keys
        for (var key in scheduleData) {
          if (scheduleData.hasOwnProperty(key)) {
            var currKey = scheduleData[key]
            if(allowedPer.indexOf(key) == -1) {
                var err = new Error("Config constant for periods not found: " + key);
                    err.status = 404;
                    return done(err);
            }
            if(currKey.hasOwnProperty("start") &amp;&amp; currKey.hasOwnProperty("end")){
                if(moment(currKey.start, "HH:mm").isBefore(moment(currKey.end, "HH:mm"))) {
                    //return done(null, moment(currKey.start, "HH:mm").utc().format("HH:mm"));
                    scheduleData[key].start = moment(currKey.start, "HH:mm").utc().format("HH:mm");
                    scheduleData[key].end = moment(currKey.end, "HH:mm").utc().format("HH:mm");
                } else {
                    var err = new Error("Start time is after end time for period: \"" + key + "\"");
                    err.status = 400;
                    return done(err)
                }
                
            } else {
                var err = new Error("start or end Key not Found");
                err.status = 400;
                return done(err);
            }
          }
        }
        //send to db
       r.table("scheduleDefinitions").insert({
            name: name,
            scheduleData: scheduleData
        }).run(dbConn, function(err, data) {
            if (err) {
                return done(err);
            }
            return done(null, data)
        }) 
    },
    /** 
    * Gets a Schedule Definition
    * @function getScheduleDefinition
    * @link module:passportApi
    * @async
    * @returns {callback} Data of the row
    * @param {object} dbConn - RethinkDB Connection Object.
    * @param {string} id - Id of the row.  in null, gets all
    * @param {function} done - Callback
    */
    getScheduleDefinition: function(dbConn, id, done) {
        if(id) {
            r.table('scheduleDefinitions').get(id).run(dbConn, function(err, data) {
                if(err) {
                    return done(err);
                }
                return done(null, data)
            });
        } else {
            r.table('scheduleDefinitions').run(dbConn, function(err, data) {
                if(err) {
                    return done(err);
                }
                data.toArray(function(err, data) {
                    if(err) {
                        return done(err);
                    }
                    return done(null, data)
                })
                
            });
        }
        
    },

    /** 
    * Schedules a date for a Schedule Definition
    * @function scheduleSingleScheduleDefinition
    * @link module:passportApi
    * @async
    * @returns {callback} Data of the action
    * @param {object} dbConn - RethinkDB Connection Object.
    * @param {string} SCid - Id of the Schedule Definition
    * @param {string} date - Moment.js compadable date
    * @param {function} done - Callback
    */
    scheduleSingleScheduleDefinition: function(dbConn, SCid, date, done) {
        if(!moment(date).isValid()) {
            var err = new Error("Date not valid");
            err.status = 400;
            return done(err)
        }
        date = moment(date).format("Y-MM-DD");
        
        r.table("scheduleCalendar").insert({
            ScheduleDefinitionID: SCid,
            date: date
        }).run(dbConn, function(err, data) {
            if(err) {
                return done(err);
            }
            return done(null, data);
        })
    },

    /** 
    * Schedules a Repeating date for a Schedule Definition
    * @function scheduleRepeatingScheduleDefinition
    * @link module:passportApi
    * @async
    * @returns {callback} Data of the action
    * @param {object} dbConn - RethinkDB Connection Object.
    * @param {string} SCid - Id of the Schedule Definition
    * @param {repeatingRule} repeatingRule - See: {@link #params-repeatingRule|&lt;a href="#params-repeatingRule">Object Example&lt;/a>}
    * @param {function} done - Callback
    */
    scheduleRepeatingScheduleDefinition: function(dbConn, SCid, repeatingRule, done) {
        //Check if repeatingRule is valid
        if(repeatingRule.repeats == "daily") {
            if(!Number.isInteger(repeatingRule.every)) {
                var err = new Error("repeatingRule.every expected a number");
                err.status = 400;
                return done(err); 
            }
            if(!repeatingRule.startsOn || !moment(repeatingRule.startsOn).isValid()) {
                var err = new Error("repeatingRule.startsOn not a date");
                err.status = 400;
                return done(err); 
            }
        } else if(repeatingRule.repeats == "weekly") {
            //if(!Number.isInteger(repeatingRule.every)) {
            if(isNaN(parseInt(repeatingRule.every))) {
                if(typeof repeatingRule.every == "string") {
                    if(isNaN(parseInt(repeatingRule.every))) {
                        var err = new Error("repeatingRule.every expected a number");
                        err.status = 400;
                        return done(err); 
                    }
                }
                var err = new Error("repeatingRule.every expected a number");
                err.status = 400;
                return done(err); 

            }
            if(!Array.isArray(repeatingRule.on)) {
                    var err = new Error("repeatingRule.on expected an Array");
                    err.status = 400;
                    return done(err); 
                }
            if(!repeatingRule.startsOn || !moment(repeatingRule.startsOn).isValid()) {
                var err = new Error("repeatingRule.startsOn not a date");
                err.status = 400;
                return done(err); 
            }
        } else {
            var err = new Error("repeatingRule has invalid syntex");
            err.status = 400;
            return done(err)
        }

        //defaults
        if(isNaN(parseInt(repeatingRule.importance))) {
            if(typeof repeatingRule.importance == "string") {
                if(isNaN(parseInt(repeatingRule.importance))) {
                    var err = new Error("repeatingRule.importance expected a number");
                    err.status = 400;
                    return done(err); 
                }
            }
            var err = new Error("repeatingRule.importance expected a number");
            err.status = 400;
            return done(err); 

        }

        repeatingRule.startsOn = moment(repeatingRule.startsOn).format("Y-MM-DD");
        r.table("scheduleRepeating").insert({
            ScheduleDefinitionID: SCid,
            repeatingRule: repeatingRule
        }).run(dbConn, function(err, data) {
            if(err) {
                return done(err);
            }
            return done(null, data);
        })
    },

    /** 
    * Gets the Schedule for that date 
    * @function getScheduleOfADate
    * @link module:passportApi
    * @async
    * @returns {callback} Array of schedules OR just a single schedule if checkImportance is true
    * @param {object} dbConn - RethinkDB Connection Object.
    * @param {string} date - Moment.js compadable date
    * @param {boolean} checkImportance - If the function should automaticly check the importance of the schedule and only return the highest importance
    * @param {function} done - Callback
    * @todo MAKE BETTER
    */

    getScheduleOfADate: function(dbConn, date, checkImportance, done) {
         if(!moment(date).isValid()) {

            var err = new Error("Date not valid");
            err.status = 400;
            return done(err)
        }
        var momentDate = moment(date);
        
        date = momentDate.format("Y-MM-DD");

        r.table("scheduleCalendar").filter({
            date: date
        }).map( r.row.merge(function(ro) {
            return {scheduleDefinition: r.table('scheduleDefinitions').get(ro('ScheduleDefinitionID'))}
        })).without('ScheduleDefinitionID').run(dbConn, function(err, cursor) {
            if(err) return done(err);
            cursor.toArray(function(err, results) {
                if(err) return done(err);
                //check if array is empty
                if(results.length > 0) {
                    //return results 
                    return done(null, results)
                } else {
                    checkRepeating();
                }
            });
            
        })

        function checkRepeating() {
            var validRows = [];
            r.table("scheduleRepeating").map( r.row.merge(function(ro) {
                return {scheduleDefinition: r.table('scheduleDefinitions').get(ro('ScheduleDefinitionID'))}
            })).without('ScheduleDefinitionID').run(dbConn, function(err, cursor) {
                if(err) return done(err);
                cursor.toArray(function(err, results) {
                    if(err) return done(err);
                    if(results.length &lt;= 0) {
                        var err = new Error("No Recurring Schedules Found");
                        err.status = 404;
                        return done(err)
                    }
                    //start checking rules
                    for(var x = 0; x &lt; results.length; x++) {
                        var startDay = moment(results[x].repeatingRule.startsOn);
                        var queryDay = moment(date);
                        //weekly
                        if(results[x].repeatingRule.repeats == "weekly") {
                            //if diffence bt weeks is below 0 then assume that it is not needed
                            var weekDif = queryDay.format('w') - startDay.format('w');
                            if(weekDif >= 0) {
                                //console.log(startDay.toString())
                                
                                //check if query week is in the set
                                if(weekDif % results[x].repeatingRule.every == 0) {
                                    //check if the day is on the rule
                                    if(results[x].repeatingRule.on.indexOf(queryDay.format("dddd").toLowerCase()) != -1) {
                                        validRows.push(results[x])
                                    }
                                }
                            }
                        }
                        /*
                        console.log(startDay.toString() + " + diff: ");
                        console.log(queryDay.format('w') - startDay.format('w'))
                        console.log("Mod:");
                        console.log(weekDif % results[x].repeatingRule.every)
                        console.log("_________");*/
                        if(x >= results.length-1) {
                            //check returns nly the most important 
                            if(checkImportance) {
                                if(validRows.length &lt;= 0) {
                                    
                                    var err = new Error("No Recurring Schedules Found");
                                    err.status = 404;
                                    return done(err)
                                }
                                if(validRows.length == 1) {

                                    return done(null, validRows[0]);
                                }
                                var mIS = validRows[0];
                                for(var i = 1; i &lt; validRows.length; i++) {

                                    if(mIS.repeatingRule.importance &lt; validRows[i].repeatingRule.importance) {
                                        
                                        mIS = validRows[i];
                                        
                                    } else if(mIS.repeatingRule.importance == validRows[i].repeatingRule.importance) {
                                        //conflicting importance fallback
                                        if(moment(mIS.repeatingRule.startsOn).isBefore(validRows[i].repeatingRule.startsOn)) {
                                            mIS = validRows[i];
                                        } else if(mIS.repeatingRule.startsOn == validRows[i].repeatingRule.startsOn) {
                                            var err = new Error("Unable to resolve conflicting schedules with repeatingRule IDs of: \"" + mIS.id + "\" AND \"" + validRows[i].id + "\"");
                                            err.status = 500;
                                            return done(err)
                                        }
                                    }

                                    //on done
                                    if(i >= validRows.length-1) {
                                        return done(null, mIS)
                                    }
                                }
                            } else {
                                return done(null, validRows);
                            }
                            
                            
                        }
                    }
                    
                    //return done(null, results)
                });
            });
        }
        

    },

        
    /**
    SECURITY
    **/
    //Wrapper for compatibility
    /*createPermissionKey: function(dbConnNull, permissions, params, timeout, done) {
        securityAPI.createPermissionKey(permissions, params, timeout, function(err, resp) {
            return done(err, resp)
        })
    },
    checkPermissionKey: function(dbConnNull, key, done) {
        securityAPI.checkPermissionKey(key, function(err, resp) {
            return done(err, resp)
        })
    },*/


    /**
    Server
    **/

     /** 
    * Gets all passgroups defined in configs 
    * @function getPassGroups
    * @link module:passportApi
    * @async
    * @returns {callback} error and array of passGroup info.
    * @param {function} done - Callback
    */
    getPassGroups: function(done) {
        var uG = config.get('userGroups');
        var pG = {};
        var i = 0;
        for (var key in uG) {
            if (uG.hasOwnProperty(key) &amp;&amp; config.has('userGroups.' + key + '.passes')) {
               //console.log(key + " -> " + uG[key]);
               pG[key] = uG[key].passes
            }
            if(i >= Object.keys(uG).length-1) {
                
                return done(null, pG);
            }
            
            i++;
        }
        
        
    },

    

    tester: function(hello, done) {
        console.log(hello);
        done(null, hello);
    }
}

/**
* The json tree for laying out the period times
* The key must equal a period constant defined in the config array (schedule.period)
* Times are in 24hr time
* @example
* {
* "a": { 
*   "start": 14:25,
*   "end": 15:35
* },
* "b": { 
*   "start": 9:25,
*   "end": 10:35
* },
* "c": { 
*   "start": 13:25,
*   "end": 14:10
* },
* "lunch2": {
*   "start": 12:00,
*   "end": 13:05
* }
* }
* @typedef {json} scheduleData
*/

/**
* rule to let the program know when to Repeats.
* @example
* &lt;caption>Repeating daily&lt;/caption>
* {
*    "startsOn": "2017-06-26",
*    "repeats": "daily",
*    "every": 1, //days
*    "importance": 0 // (Defaults to: 0) if a conflict happens between two diffrent Repeating schedules, the program can deside what schedule to use.  NOTE: Not implemented in API  
* }
* @example
* &lt;caption>Repeating Weekly&lt;/caption>
* {
    "startsOn": "2017-06-26",
    "repeats": "weekly",
    "every": 1, //weeks
    "on": ["monday", "tuesday", "thursday", "friday"],
*    "importance": 1 // (Defaults to: 0) if a conflict happens between two diffrent Repeating schedules, the program can deside what schedule to use.  NOTE: Not implemented in API
* }
* @typedef {json} repeatingRule
*/</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Jan 30 2018 04:51:44 GMT+0000 (UTC) using the LOKE theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
