{{>head}}
<!--
Passport-Live is a modern web app for schools that helps them manage passes.
    Copyright (C) 2017  Joseph Hassell

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

email: hi@josephhassell.com
-->

<body class="grey darken-4">

        <!--Loading Screen-->
        <section id="fullAjaxLoadingScreen" class="loadingScreen loading">


            <div class="vCenter">

              {{>mixens/logoLoader}}

            </div>

<!--342x470-->
        </section>




      <!-- Normal Page -->


    <!--Navbar-->
    <nav id="navBar">
        <div class="nav-wrapper">
          <!--SideNav-->
          <ul id="slide-out" class="side-nav">
           <li><div class="userView">
             <div class="background">
               <img alt="Side-Nav Background" src="images/stunav.jpg">
             </div>
             <a href="#!user"><i class="material-icons md-48 md-light">account_circle</i></a>
             <a href="#!name"><span class="white-text name">{{account_FirstName}} {{account_LastName}}</span></a>
             <a href="#!email"><span class="white-text email">{{account_Email}}</span></a>
           </div></li>
           <li><a class="waves-effect" href="#!">Home</a></li>
           <li><a class="waves-effect" href="students/account.php">Your Account</a></li>
           <li><div class="divider"></div></li>
           <!--<li><a class="subheader">Subheader</a></li>-->
           <li><a class="waves-effect" href="auth/logout">Logout<i class="material-icons right">lock_outline</i></a></li>

         </ul>
          <a href="#" data-activates="slide-out" class="nav-sandwich button-collapse left-allign show-on-large"><i class="material-icons">menu</i></a>
            <a href="#" class="brand-logo center">Passport</a>
            <span class="nav-right">{{passport_Version}}</span>
        </div>
    </nav>

    <div id="confirmOver" class="overlay-full">
      <div class="overlay-content">
      <div id="checkmarkAnimationfull">

    </div>
      <h1>
      <h1 id="ConfirmOverlayWords" class="center white-text">Pass Requested</h1>
      <a href="javascript:void(0)" class="closebtn-overlay" onclick="closeFullOverlay('confirmOver', 0)">&times;</a>
    </div>
  </div>
    <!--FEEDBACK FAB-->


    <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
        <a class="btn-floating btn-large tooltipped" data-position="left" data-delay="50" data-tooltip="Feedback">
            <i class="large material-icons">assignment</i>
        </a>
        <ul>
            <li><a class="btn-floating red modal-trigger tooltipped" data-position="left" data-delay="50" data-tooltip="Bug Report" href="#bugmodal"><i class="material-icons">report_problem</i></a></li>
            <li><a class="btn-floating yellow darken-1 modal-trigger tooltipped" data-position="left" data-delay="50" data-tooltip="Leave A Review" href="#reviewmodaldis"><i class="material-icons">thumbs_up_down</i></a></li>
            <li><a class="btn-floating green tooltipped" data-position="left" data-delay="50" data-tooltip="Wiki" href="https://poster983.github.io/Passport-Live/"><i class="material-icons">live_help</i></a></li>
            <li><a class="btn-floating blue tooltipped" data-position="left" data-delay="50" data-tooltip="Github" href="https://github.com/poster983/passport/"><i class="material-icons">code</i></a></li>
        </ul>
    </div>





  <!-- Bug Modal -->
  <div id="bugmodal" class="modal bottom-sheet">
    <div class="modal-content">
        <h4>Bug report</h4>
        <div class="row">
            <form class="col s12" method="post" action="">
                <div class="row">
                    <div class="input-field col s12"> <i class="material-icons prefix">comment</i>
                        <textarea id="bugtext" name="bugtext" required class="materialize-textarea"></textarea>
                        <label for="bugtext">Describe the bug or issue</label>
                    </div>
                    <h5 class="center">Bug Severity Slider</h5>
                    <p class="center">1 being low priority and 5 being high priority</p>
                        <p class="range-field">
                            <input type="range" id="bugseverity" name="bugseverity" min="1" max="5" value="3" />
                        </p>
                </div>
                <div class="modal-footer">

                    <button class="btn waves-effect waves-light modal-action modal-close" type="submit" name="submitbug">Submit Bug Report
                        <i class="material-icons right">send</i>
                    </button>
                </div>
            </form>
        </div>

    </div>

  </div>



      <!--Review Modal disclaimer -->
  <div id="reviewmodaldis" class="modal">
    <div class="modal-content">
      <h4>Reminder</h4>
      <p>A review should include helpful information. Reviews that are bias and/or spam will be ignored.</p>
    </div>
    <div class="modal-footer">
      <a href="#reviewmodal" class=" modal-action modal-close modal-trigger waves-effect waves-green btn-flat">I Agree</a>
    </div>
  </div>

    <!-- Review Modal -->
  <div id="reviewmodal" class="modal bottom-sheet">
    <div class="modal-content">
        <h4>Leave a review</h4>
        <div class="row">
            <form class="col s12" method="post" action="">
                <div class="row">

                    <div class="input-field col s12"> <i class="material-icons prefix">comment</i>
                        <textarea id="reviewtext" name="reviewtext" class="materialize-textarea"></textarea>
                        <label for="reviewtext">Comment</label>
                    </div>
                    <h5 class="center">Rating Slider</h5>

                        <p class="range-field">
                            <input type="range" id="rating" name="rating" min="1" max="10" value="5" />
                        </p>
                </div>
                <div class="modal-footer">

                    <button class="btn waves-effect waves-light modal-action modal-close" type="submit" name="submitreview">Submit Review
                        <i class="material-icons right">send</i>
                    </button>
                </div>
            </form>
        </div>

    </div>

  </div>



    <!-- System Message-->
        <div id="ajaxAllStudentMess"></div>
        <!--login Message-->
       <div class='row'>
            <div class='col s12'>
              <div class='card-panel teal'>
                <h1>NOTE FROM LAST LOGIN!</h1>
                <h3>{{passport_LoginMessage}}</h3>
              </div>
            </div>
          </div>

        <div class="container">
          <div class="section">
            <div class="row">
              <div class="col s12">
                <div id="behindCard"></div>
                <div id="PassCard" class="card grey darken-3 hoverable">
                  <div class="card-content white-text">
                    <span class="card-title">Get A Pass</span>

                      <form id="passForm" method="post">
                          <div id="groDiv" class="input-field col s12">
                            <select id="passGroup" name="passGroup" required class="white-text validate" onchange="onPassGroupSelectChange(this)">
                              <option value="" disabled selected>Choose A Group</option>
                            </select>
                            <label>Group</label>
                          </div>
                          <!-- Immagine this shows when "passGroup" finishes -->
                          <!--Search-->
                          <div id="searchDiv" class="input-field col s12" style="display: none;">
                            <input type="text" id="autocomplete-account" class="autocomplete">
                            <label for="autocomplete-account">Search People</label>
                          </div>
                          <!--Select People-->
                          <div id="selectPeopleDiv" class="input-field col s12" style="display: none;">
                            <select id="selectPeople" name="selectPeople" required class="white-text validate" onchange="onSelectPeopleChange(this)">
                              <option value="" disabled selected>Choose A Person</option>
                            </select>
                            <label>Select a Person</label>
                          </div>

                          <!--Pick a Date -->
                          <div id="dayToCome" class="input-field col s12" style="display: none;">
                            <input type="date" id="datepicker" name="dayToCome" class="datepicker" onchange="onDateChange(this)">
                            <label for="datepicker">Day To Come</label>
                          </div>

                           <!--Select Period-->
                          <div id="selectPeriodDiv" class="input-field col s12" >
                            
                          </div>

                          <br>
                          <br>
                          <br>
                          <br>
                          <br>
                          <br>
                          <br>
                        <!--Advanced-->
                      <div>
                        <input type="checkbox" id="sao" />
                        <label for="sao">Show Advanced Options</label>
                      </div>
                      <div class="divider"></div>
                      <div id="passrequestAdvanced" style="display: none;">
                        <h5 class="center white-text">Advanced Options</h5>
                        <div class="divider"></div>
                        <p class="center white-text">Nothing Here Yet.</p>
                      </div>
                      <div class="section">
                        <a class="waves-effect waves-light btn-large red" id="submitPass" disabled onclick="submitPass(<?php echo $_SESSION['studentAccID'] ?>, 0);">Submit Pass<span id="subPassAdv"><i class='material-icons right'>send</i></span></a>
                        <span id="debugSubmit"></span>
                      </div>
                    </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- MyPasses-->
            <div class="section">
              <div class="row">
                <div class="col s12">
                  <div id="MyPassesCard" class="card grey darken-3 hoverable">
                    <div class="card-content white-text">
                      <span class="card-title">My Passes<sup>Beta</sup></span>
                      <div id="myPassesReturn"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>



        <!-- Scripts -->
        <!--[if lte IE 8]><script src="assets/js/respond.min.js"></script><![endif]-->
        <script>
            if ('addEventListener' in window) {
                window.addEventListener('load', function () {
                    document.body.className = document.body.className.replace(/\bis-loading\b/, '');
                });
                document.body.className += (navigator.userAgent.match(/(MSIE|rv:11\.0)/) ? ' is-ie' : '');
            }
        </script>
        <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

        <!-- Compiled and minified JavaScript -->
        <script src="js/materialize.js"></script>
        <script src="js/passport.js"></script>
        <!--<script src="js/PICS.js"></script>-->
        <script>
              /*Vars*/
              var currGroup = "";
              var toPerson = "";
              var dayToCome = "";

              $(document).ready(function(){
                // the "href" attribute of .modal-trigger must specify the modal ID that wants to be triggered
                $('.modal').modal();
                $(".button-collapse").sideNav();
                $('.tooltipped').tooltip({delay: 50});
                $('select').material_select();
                //temp
                $('#fullAjaxLoadingScreen').removeClass("loading");
                
                $.when(setPassGroupSelect(), checkDebugModeCookies()).done(function(a1, a2){
                  $('#fullAjaxLoadingScreen').removeClass("loading");
                });
                
                initAutocompleteAccounts({"none": null});
                
              });

              function debugMode() {

                if (getCookie("debugMode") == "") {
                  document.cookie = "debugMode=1";
                  toggleDebugModeDOMElements(true);
                } else if (getCookie("debugMode") == 1){
                  document.cookie = "debugMode=0";
                  toggleDebugModeDOMElements(false);
                } else if (getCookie("debugMode") == 0){
                  document.cookie = "debugMode=1";
                  toggleDebugModeDOMElements(true);
                }
              }
              function checkDebugModeCookies() {
                if (getCookie("debugMode") == 1){
                  toggleDebugModeDOMElements(true);
                }
              }
              function toggleDebugModeDOMElements(state) {
                if (state) {
                  $('#debugSubmit').html("<a class='waves-effect waves-light btn-large red' id='debugSubmitPass' onclick=\"submitPass(<?php echo $_SESSION['studentAccID'] ?>, 1);\">Debug Submit Pass<span id='subPassAdv'><i class='material-icons right'>send</i></span></a>");
                } else {
                  $('#debugSubmit').html("");
                }
              }

              function carsonRau(){
                $(document.body).css('background-image', 'url(/passport/image/cork-board.jpg)');
                console.log("There You Go Carson");
              }

              /**Fill Pass Groups**/

              function getPassGroups(done) {
                $.ajax({
                    type: "get",
                    url: "/api/server/config/passGroup",
                    dataType: "json",
                    success: function(data) {
                      return done(null, data);
                    },
                    error: function(jqXHR) {
                      return done(jqXHR);
                    }                      
                  });
              }
              function setPassGroupSelect() {
                getPassGroups(function(err, data) {
                  if(err) {
                    errorHand(err);
                  }
                  for(var it = 0; it < Object.keys(data).length; it++) {
                    var key = Object.keys(data)[it];
                    console.log(Object.keys(data)[it])
                    $('#passGroup').append("<option value=\'" + key + "\' data-prefersearch=\'" + data[key].preferSearch + "\'>" + data[key].viewName + "</option>");
                    if(it >= Object.keys(data).length-1) {
                      //re init the select
                      $('#passGroup').material_select();
                      
                    }
                  }
                })
              }


              function onPassGroupSelectChange(select) {
                console.log(select)
                //delete all dchildern
                 $('#selectPeople').empty();
                 initAutocompleteAccounts({});
                 $('#selectPeople').material_select();
                currGroup = select.value;
                if($(select).find(':selected').attr('data-prefersearch') == "true") {
                  console.log("yes")
                  $("#searchDiv").show();
                  $("#selectPeopleDiv").hide();
                } else {
                  //trigger getting all usergroups in the passGroup for a select
                  preparePeopleSelect(currGroup);
                  
                  $("#searchDiv").hide();
                  $("#selectPeopleDiv").show();
                }
              }
              function preparePeopleSelect(userGroup) {
                 $.ajax({
                    type: "get",
                    url: "/api/account/"+userGroup,
                    //dataType: "json",
                    success: function(data) {
                      //set data
                      console.log(data)
                      for(var i = 0; i < data.length; i++ ) {
                        $('#selectPeople').append("<option value=\'" + data[i].id + "\'>" + data[i].name.first + " " + data[i].name.last + "</option>");
                        console.log(data[i].id)
                        if(i >= data.length-1) {
                          //re init the select
                          $('#selectPeople').material_select();
                          
                        }
                      }
                    },
                    error: function(jqXHR) {
                      errorHand(jqXHR)
                    }                      
                  });
              }

              //when the people select changes 

              function onSelectPeopleChange(select) {
                //get full account data 
                searchAccountsByID(select.value, function(err, data) {
                  if(err) {
                    errorHand(err);
                  } else {
                    toPerson = data;
                    //check date settings set by teacher dash 
                    var advance = toPerson.groupFields.teacher.settings.daysInAdvanceForPasses;
                    var endDate = new Date();
                    endDate.setDate(endDate.getDate() + advance)
                    console.log(endDate.toString())
                    setupDatePicker(endDate, [])
                  }

                })
              }

                /**Autocomplete Accounts**/
                function initAutocompleteAccounts(data) {
                  $('input.autocomplete').autocomplete({
                    data: data,
                    onAutocomplete: function(val) {
                      toPerson = val;
                    },
                    minLength: 1, // The minimum length of the input for the autocomplete to start. Default: 1.
                  });
                }


                
                    
                $("#autocomplete-account").keyup(function() {
                  searchAccounts(currGroup, $("#autocomplete-account").val(), function(err, data) {
                    if(err) {
                      console.error(err);
                    }
                    else if(data) {
                      var newDataAuto = {};
                      //initAutocompleteAccounts({"joey": null});

                      console.log(data)
                      for(var x = 0; x < data.length; x++) {
                        if(data[x].name.salutation) {
                          newDataAuto[data[x].name.salutation + ' ' + data[x].name.last] = null;
                        } else if(data[x].name.salutation && data[x].name.first) {
                          newDataAuto[data[x].name.salutation + ' ' + data[x].name.first + ' ' + data[x].name.last] = null;
                        } else {
                          newDataAuto[data[x].name.first + ' ' + data[x].name.last] = null;
                        }

                      }
                      console.log(newDataAuto)
                      initAutocompleteAccounts(newDataAuto);
                      //autocompleteAccounts.resultCache = newDataAuto;
                      //autocompleteAccounts.setValue(newDataAuto);
                    } 
                  });
                  console.log($("#autocomplete-account").val())
                })
              
              
                function searchAccounts(userGroup, query, done) {
                    if(!query|| userGroup == "") {
                      return done(null, null);
                    }
                   $.ajax({
                    type: "get",
                    url: "/api/account/"+userGroup+"/"+query,
                    dataType: "json",
                    success: function(data) {done(null, data)},
                    error: function(jqXHR) {done(jqXHR)}                      
                  });
                  /*sendAPI("/api/account/"+userGroup+"/"+query, "get", null, 123, function(err, data) {
                    if(err) {
                      console.error(err);
                    } else {
                      return data;
                    }

                  });*/
                }

                function searchAccountsByID(id, done) {
                    if(id == "") {
                      return done(null, null);
                    }
                   $.ajax({
                    type: "get",
                    url: "/api/account/id/"+id,
                    dataType: "json",
                    success: function(data) {done(null, data)},
                    error: function(jqXHR) {done(jqXHR)}                      
                  });
                }


                /* Date Things */

                function setupDatePicker(max, disable) {
                  $('#dayToCome').show();
                  $('#datepicker').pickadate({
                    selectMonths: true, // Creates a dropdown to control month
                    selectYears: 2, // Creates a dropdown of 15 years to control year
                    min: new Date(),
                    max: max,
                    disable: disable,
                    formatSubmit: 'yyyy-mm-dd',
                    hiddenName: true
                  });
                }

                function onDateChange(date) {
                  //get hidden date vfalue
                  dayToCome = $('[name=dayToCome]').val();
                  setupPeriods();
                }

                /* Periods */

                function setupPeriods() {
                  if(dayToCome == "") {
                    return false;
                  }
                  $('#selectPeriodDiv').empty();
                  $.ajax({
                    type: "get",
                    url: "/api/schedule/for/"+dayToCome,
                    dataType: "json",
                    success: function(data) {
                      console.log(data);
                      //multiple periods
                      if(data.length > 0 ) {
                        //most important schedule
                        var mIS = {repeatingRule: {importance: Number.MIN_VALUE}};
                        for(var i = 0; i < data.length; i++) {
                          if(data[i].repeatingRule.importance > mIS.repeatingRule.importance ) {
                            mIS = data[i]
                          }
                          //end
                          if(i >= data.length-1 ) {
                            console.log(mIS)

                            var periods = Object.keys(mIS.scheduleDefinition.scheduleData)
                            console.log(periods);
                            for(var x = 0; x < periods.length; x++) {
                                $('#selectPeriodDiv').append("<input name=\"period\" type=\"radio\" id=" + periods[x] +" /> ");
                                $('#selectPeriodDiv').append("<label for="+ periods[x] +">" + periods[x].charAt(0).toUpperCase() +  periods[x].slice(1) + "</label> &nbsp &nbsp");
                            }
                          }
                        }
                      }

                    },
                    error: function(jqXHR) {errorHand(jqXHR)}                      
                  });
                } 


                function errorHand(err) {
                  //Do more Later
                  console.error(err);
                }

                 $("#sao").change(function() {
                  if(this.checked) {
                    $('#passrequestAdvanced').show();
                      $('#passrequestAdvanced').animateCss('bounceIn');
                      $('#subPassAdv').html(" (Using Advanced Options) <i class='material-icons right'>error_outline</i>");
                  } else {
                    $('#passrequestAdvanced').animateCss('bounceOut');
                    $('#passrequestAdvanced').one('webkitAnimationEnd oanimationend msAnimationEnd animationend',
                  function(e) {
                    $('#passrequestAdvanced').hide();
                    $('#subPassAdv').html("<i class='material-icons right'>send</i>");
                  });
                  }
              });

              </script>

  </body>
  </html>
