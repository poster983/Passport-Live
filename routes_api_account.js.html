<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes/api/account.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="nav">
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-Configs.html">Configs</a></li><li><a href="tutorial-Setup Error Monitoring.html">Setup Error Monitoring</a></li><li><a href="tutorial-Usergroup Database Models.html">Usergroup Database Models</a></li><li><a href="tutorial-Web App System Requirements.html">Web App System Requirements</a></li></ul><h3>API</h3><ul><li><a href="#">/api/account/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~searchAccounts">GET</a></li></ul></li><li><a href="#">/api/account/email/:email/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getAccountsByEmail">GET</a></li></ul></li><li><a href="#">/api/account/groupfields/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleUpdateAccountGroupFieldsByUser">PATCH</a></li></ul></li><li><a href="#">/api/account/hasClasses</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getAccountsWithClasses">GET</a></li></ul></li><li><a href="#">/api/account/id/:id</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsById">GET</a></li></ul></li><li><a href="#">/api/account/incomplete/dashboard/student</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~studentCheckIfIncomplete">GET</a></li></ul></li><li><a href="#">/api/account/location/datetime/:dateTime/id/:id/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getCurrentLocation">GET</a></li></ul></li><li><a href="#">/api/account/name/:name/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByName">GET</a></li></ul></li><li><a href="#">/api/account/new/:userGroup/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleNewAccount">POST</a></li></ul></li><li><a href="#">/api/account/password/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~updateUserPassword">PATCH</a></li></ul></li><li><a href="#">/api/account/schedule/:dashboard</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~setUserSchedule">POST</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">PATCH</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">PUT</a></li></ul></li><li><a href="#">/api/account/schedule/[:id]</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getAllSchedules">GET</a></li></ul></li><li><a href="#">/api/account/schedule/student/:id</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForStudentDash">GET</a></li></ul></li><li><a href="#">/api/account/schedule/teacher/:id</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForTeacherDash">GET</a></li></ul></li><li><a href="#">/api/account/userGroup/:userGroup/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByUserGroup">GET</a></li></ul></li><li><a href="#">/api/account/userGroup/:userGroup/name/:name/</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByNameAndUserGroup">GET</a></li></ul></li><li><a href="#">/api/auth/login/</a><ul class='methods'><li data-type='method'><a href="module-authRESTAPI.html#~handleAuthLogin">POST</a></li></ul></li><li><a href="#">/api/auth/login/dscm</a><ul class='methods'><li data-type='method'><a href="module-authRESTAPI.html#~loginDSCM">POST</a></li></ul></li><li><a href="#">/api/blackout/</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~newBlackout">POST</a></li></ul></li><li><a href="#">/api/blackout/date/:date</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByDate">POST</a></li></ul></li><li><a href="#">/api/blackout/user/:userId</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserId">POST</a></li></ul></li><li><a href="#">/api/blackout/user/:userId/date/:date</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserIdAndDate">POST</a></li></ul></li><li><a href="#">/api/import/accounts</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~importJsonAccounts">POST</a></li></ul></li><li><a href="#">/api/import/accounts/:bulkID/activate</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~activate">POST</a></li></ul></li><li><a href="#">/api/import/accounts/:bulkID/rollback</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~rollback">DELETE</a></li></ul></li><li><a href="#">/api/import/log</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~searchBulkImport">GET</a></li></ul></li><li><a href="#">/api/media/avatar/:id/:size.svg</a><ul class='methods'><li data-type='method'><a href="module-mediaRESTAPI.html#~getIdenticon">GET</a></li></ul></li><li><a href="#">/api/media/background/:id.svg</a><ul class='methods'><li data-type='method'><a href="module-mediaRESTAPI.html#~generateBackdrop">GET</a></li></ul></li><li><a href="#">/api/passes/me/</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~newPassForMe">POST</a></li></ul></li><li><a href="#">/api/passes/me/by/:idCol/from/:fromDay/</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromDay">GET</a></li></ul></li><li><a href="#">/api/passes/me/by/:idCol/from/:fromDay/to/:toDay</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromToDay">GET</a></li></ul></li><li><a href="#">/api/passes/status/:passId/isMigrating/:state</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~updateMigrationStatus">PATCH</a></li></ul></li><li><a href="#">/api/passes/status/:passId/state/:state</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~updatePassState">PATCH</a></li></ul></li><li><a href="#">/api/security/key/:type</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~getPermissionKeyData">GET</a></li></ul></li><li><a href="#">/api/security/key/API/</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~handleNewApiKey">POST</a></li></ul></li><li><a href="#">/api/security/key/NEW_ACCOUNT/</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~handleCreatePermissionKey">POST</a></li></ul></li><li><a href="#">/api/server/config/passGroup/</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~handleGetAccountsByName">GET</a></li></ul></li><li><a href="#">/api/server/config/schedule/</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~getScheduleConstants">GET</a></li></ul></li><li><a href="#">/api/server/config/userGroups/</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~getUserGroups">GET</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api_accounts.html">api/accounts</a><ul class='methods'><li data-type='method'><a href="module-api_accounts.html#~getAccountsByEmail">getAccountsByEmail</a></li><li data-type='method'><a href="module-api_accounts.html#~getAccountsWithClasses">getAccountsWithClasses</a></li><li data-type='method'><a href="module-api_accounts.html#~getCurrentLocation">getCurrentLocation</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsById">handleGetAccountsById</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByName">handleGetAccountsByName</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByNameAndUserGroup">handleGetAccountsByNameAndUserGroup</a></li><li data-type='method'><a href="module-api_accounts.html#~handleGetAccountsByUserGroup">handleGetAccountsByUserGroup</a></li><li data-type='method'><a href="module-api_accounts.html#~handleNewAccount">handleNewAccount</a></li><li data-type='method'><a href="module-api_accounts.html#~handleUpdateAccountGroupFieldsByUser">handleUpdateAccountGroupFieldsByUser</a></li><li data-type='method'><a href="module-api_accounts.html#~searchAccounts">searchAccounts</a></li><li data-type='method'><a href="module-api_accounts.html#~studentCheckIfIncomplete">studentCheckIfIncomplete</a></li><li data-type='method'><a href="module-api_accounts.html#~updateUserPassword">updateUserPassword</a></li></ul></li><li><a href="module-api_import.html">api/import</a><ul class='methods'><li data-type='method'><a href="module-api_import.html#~activate">activate</a></li><li data-type='method'><a href="module-api_import.html#~importJsonAccounts">importJsonAccounts</a></li><li data-type='method'><a href="module-api_import.html#~rollback">rollback</a></li><li data-type='method'><a href="module-api_import.html#~searchBulkImport">searchBulkImport</a></li></ul></li><li><a href="module-api_userSchedule.html">api/userSchedule</a><ul class='methods'><li data-type='method'><a href="module-api_userSchedule.html#~getAllSchedules">getAllSchedules</a></li><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForStudentDash">getSchedulesForStudentDash</a></li><li data-type='method'><a href="module-api_userSchedule.html#~getSchedulesForTeacherDash">getSchedulesForTeacherDash</a></li><li data-type='method'><a href="module-api_userSchedule.html#~setUserSchedule">setUserSchedule</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">updateUserSchedule</a></li><li data-type='method'><a href="module-api_userSchedule.html#~updateUserSchedule">updateUserSchedule</a></li></ul></li><li><a href="module-apiRoute.html">apiRoute</a><ul class='methods'><li data-type='method'><a href="module-apiRoute.html#~getScheduleConstants">getScheduleConstants</a></li><li data-type='method'><a href="module-apiRoute.html#~getUserGroups">getUserGroups</a></li><li data-type='method'><a href="module-apiRoute.html#~handleAuthLogin">handleAuthLogin</a></li><li data-type='method'><a href="module-apiRoute.html#~handleGetAccountsByName">handleGetAccountsByName</a></li></ul></li><li><a href="module-authRESTAPI.html">authRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-authRESTAPI.html#~handleAuthLogin">handleAuthLogin</a></li><li data-type='method'><a href="module-authRESTAPI.html#~loginDSCM">loginDSCM</a></li></ul></li><li><a href="module-blackoutAPI.html">blackoutAPI</a></li><li><a href="module-blackoutRESTAPI.html">blackoutRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByDate">getBlackoutByDate</a></li><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserId">getBlackoutByUserId</a></li><li data-type='method'><a href="module-blackoutRESTAPI.html#~getBlackoutByUserIdAndDate">getBlackoutByUserIdAndDate</a></li><li data-type='method'><a href="module-blackoutRESTAPI.html#~newBlackout">newBlackout</a></li></ul></li><li><a href="module-js_accounts.html">js/accounts</a><ul class='methods'><li data-type='method'><a href="module-js_accounts.html#.get">get</a></li><li data-type='method'><a href="module-js_accounts.html#.newUserSchedule">newUserSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#.replaceUserSchedule">replaceUserSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#.updateUserSchedule">updateUserSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#~changePassword">changePassword</a></li><li data-type='method'><a href="module-js_accounts.html#~createAccount">createAccount</a></li><li data-type='method'><a href="module-js_accounts.html#~getAccountByEmail">getAccountByEmail</a></li><li data-type='method'><a href="module-js_accounts.html#~getSpecificPeriods">getSpecificPeriods</a></li><li data-type='method'><a href="module-js_accounts.html#~getStudentSchedule">getStudentSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#~getTeacherSchedule">getTeacherSchedule</a></li><li data-type='method'><a href="module-js_accounts.html#~getUserByID">getUserByID</a></li><li data-type='method'><a href="module-js_accounts.html#~getUserGroupAccountByName">getUserGroupAccountByName</a></li><li data-type='method'><a href="module-js_accounts.html#~getUserGroupAccountByUserGroup">getUserGroupAccountByUserGroup</a></li><li data-type='method'><a href="module-js_accounts.html#~setVerification">setVerification</a></li><li data-type='method'><a href="module-js_accounts.html#~updateAccountGroupFieldsByID">updateAccountGroupFieldsByID</a></li><li data-type='method'><a href="module-js_accounts.html#~updatePassword">updatePassword</a></li><li data-type='method'><a href="module-js_accounts.html#~updateTags">updateTags</a></li><li data-type='method'><a href="module-js_accounts.html#~verifyPassword">verifyPassword</a></li></ul></li><li><a href="module-js_email.html">js/email</a><ul class='methods'><li data-type='method'><a href="module-js_email.html#~sendActivationEmail">sendActivationEmail</a></li><li data-type='method'><a href="module-js_email.html#~sendMail">sendMail</a></li><li data-type='method'><a href="module-js_email.html#~sendResetPasswordEmail">sendResetPasswordEmail</a></li></ul></li><li><a href="module-js_emailTemplates.html">js/emailTemplates</a></li><li><a href="module-js_import.html">js/import</a><ul class='methods'><li data-type='method'><a href="module-js_import.html#~deleteBulkLog">deleteBulkLog</a></li><li data-type='method'><a href="module-js_import.html#~importAccountsExcel">importAccountsExcel</a></li><li data-type='method'><a href="module-js_import.html#~mapAccounts">mapAccounts</a></li><li data-type='method'><a href="module-js_import.html#~newBulkLog">newBulkLog</a></li><li data-type='method'><a href="module-js_import.html#~updateBulkLog">updateBulkLog</a></li></ul></li><li><a href="module-js_passes.html">js/passes</a><ul class='methods'><li data-type='method'><a href="module-js_passes.html#.flexableGetPasses">flexableGetPasses</a></li><li data-type='method'><a href="module-js_passes.html#.getPass">getPass</a></li><li data-type='method'><a href="module-js_passes.html#.limitTally">limitTally</a></li><li data-type='method'><a href="module-js_passes.html#.newPass">newPass</a></li><li data-type='method'><a href="module-js_passes.html#.updatePass">updatePass</a></li></ul></li><li><a href="module-js_schedules.html">js/schedules</a><ul class='methods'><li data-type='method'><a href="module-js_schedules.html#~getActivePeriodsAtDateTime">getActivePeriodsAtDateTime</a></li></ul></li><li><a href="module-js_security.html">js/security</a><ul class='methods'><li data-type='method'><a href="module-js_security.html#.checkPermissionKey">checkPermissionKey</a></li><li data-type='method'><a href="module-js_security.html#.checkPermissionKeyValidity">checkPermissionKeyValidity</a></li><li data-type='method'><a href="module-js_security.html#.cleanDB">cleanDB</a></li><li data-type='method'><a href="module-js_security.html#.createPermissionKey">createPermissionKey</a></li><li data-type='method'><a href="module-js_security.html#.getPermissionKeyData">getPermissionKeyData</a></li><li data-type='method'><a href="module-js_security.html#.keyUsed">keyUsed</a></li><li data-type='method'><a href="module-js_security.html#.newKey.activateAccount">newKey.activateAccount</a></li><li data-type='method'><a href="module-js_security.html#.newKey.newAccount">newKey.newAccount</a></li><li data-type='method'><a href="module-js_security.html#.newKey.resetPassword">newKey.resetPassword</a></li></ul></li><li><a href="module-js_userSchedule.html">js/userSchedule</a><ul class='methods'><li data-type='method'><a href="module-js_userSchedule.html#.get">get</a></li><li data-type='method'><a href="module-js_userSchedule.html#.getStudentSchedule">getStudentSchedule</a></li><li data-type='method'><a href="module-js_userSchedule.html#.getTeacherSchedule">getTeacherSchedule</a></li><li data-type='method'><a href="module-js_userSchedule.html#.new">new</a></li><li data-type='method'><a href="module-js_userSchedule.html#.replace">replace</a></li><li data-type='method'><a href="module-js_userSchedule.html#.update">update</a></li></ul></li><li><a href="module-js_utils.html">js/utils</a><ul class='methods'><li data-type='method'><a href="module-js_utils.html#.checkPermission">checkPermission</a></li><li data-type='method'><a href="module-js_utils.html#.compileDashboardNav">compileDashboardNav</a></li><li data-type='method'><a href="module-js_utils.html#.getAllowedDashboards">getAllowedDashboards</a></li><li data-type='method'><a href="module-js_utils.html#.middlewarePermission">middlewarePermission</a></li><li data-type='method'><a href="module-js_utils.html#~checkPasswordPolicy">checkPasswordPolicy</a></li><li data-type='method'><a href="module-js_utils.html#~checkPeriod">checkPeriod</a></li><li data-type='method'><a href="module-js_utils.html#~cleanUser">cleanUser</a></li><li data-type='method'><a href="module-js_utils.html#~dscm">dscm</a></li><li data-type='method'><a href="module-js_utils.html#~generateSecureKey">generateSecureKey</a></li><li data-type='method'><a href="module-js_utils.html#~getBrowserSupport">getBrowserSupport</a></li></ul></li><li><a href="module-js_utils_rateLimit.html">js/utils/rateLimit</a><ul class='methods'><li data-type='method'><a href="module-js_utils_rateLimit.html#~emailPasswordResetBruteforce">emailPasswordResetBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~emailPasswordResetBruteforce">emailPasswordResetBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~emailPasswordResetBruteforce">emailPasswordResetBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~loginBruteforce">loginBruteforce</a></li><li data-type='method'><a href="module-js_utils_rateLimit.html#~loginBruteforce">loginBruteforce</a></li></ul></li><li><a href="module-mediaRESTAPI.html">mediaRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-mediaRESTAPI.html#~generateBackdrop">generateBackdrop</a></li><li data-type='method'><a href="module-mediaRESTAPI.html#~getIdenticon">getIdenticon</a></li></ul></li><li><a href="module-miscRESTApi.html">miscRESTApi</a></li><li><a href="module-passportApi.html">passportApi</a><ul class='methods'><li data-type='method'><a href="module-passportApi.html#~getPassGroups">getPassGroups</a></li><li data-type='method'><a href="module-passportApi.html#~getScheduleDefinition">getScheduleDefinition</a></li><li data-type='method'><a href="module-passportApi.html#~getScheduleOfADate">getScheduleOfADate</a></li><li data-type='method'><a href="module-passportApi.html#~newScheduleDefinition">newScheduleDefinition</a></li><li data-type='method'><a href="module-passportApi.html#~scheduleRepeatingScheduleDefinition">scheduleRepeatingScheduleDefinition</a></li><li data-type='method'><a href="module-passportApi.html#~scheduleSingleScheduleDefinition">scheduleSingleScheduleDefinition</a></li></ul></li><li><a href="module-passportAuthApi.html">passportAuthApi</a><ul class='methods'><li data-type='method'><a href="module-passportAuthApi.html#~newJWT">newJWT</a></li><li data-type='method'><a href="module-passportAuthApi.html#~newJWTForCookies">newJWTForCookies</a></li></ul></li><li><a href="module-passRESTApi.html">passRESTApi</a><ul class='methods'><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromDay">getPassForMeFromDay</a></li><li data-type='method'><a href="module-passRESTApi.html#~getPassForMeFromToDay">getPassForMeFromToDay</a></li><li data-type='method'><a href="module-passRESTApi.html#~newPassForMe">newPassForMe</a></li><li data-type='method'><a href="module-passRESTApi.html#~updateArrivedStatus">updateArrivedStatus</a></li><li data-type='method'><a href="module-passRESTApi.html#~updateMigrationStatus">updateMigrationStatus</a></li><li data-type='method'><a href="module-passRESTApi.html#~updatePassState">updatePassState</a></li></ul></li><li><a href="module-securityRESTAPI.html">securityRESTAPI</a><ul class='methods'><li data-type='method'><a href="module-securityRESTAPI.html#~getPermissionKeyData">getPermissionKeyData</a></li><li data-type='method'><a href="module-securityRESTAPI.html#~handleCreatePermissionKey">handleCreatePermissionKey</a></li><li data-type='method'><a href="module-securityRESTAPI.html#~handleNewApiKey">handleNewApiKey</a></li></ul></li><li><a href="module-webpack_api_accounts.html">webpack/api/accounts</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_accounts.html#.get">get</a></li><li data-type='method'><a href="module-webpack_api_accounts.html#.getWithClasses">getWithClasses</a></li></ul></li><li><a href="module-webpack_api_import.html">webpack/api/import</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_import.html#.accounts">accounts</a></li><li data-type='method'><a href="module-webpack_api_import.html#.searchBulkLogs">searchBulkLogs</a></li></ul></li><li><a href="module-webpack_api_misc.html">webpack/api/misc</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_misc.html#.getScheduleConfig">getScheduleConfig</a></li><li data-type='method'><a href="module-webpack_api_misc.html#.getUserGroups">getUserGroups</a></li></ul></li><li><a href="module-webpack_api_schedule.html">webpack/api/schedule</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_schedule.html#.getSchedules">getSchedules</a></li><li data-type='method'><a href="module-webpack_api_schedule.html#.newSchedule">newSchedule</a></li><li data-type='method'><a href="module-webpack_api_schedule.html#.replaceSchedule">replaceSchedule</a></li><li data-type='method'><a href="module-webpack_api_schedule.html#.updateSchedule">updateSchedule</a></li></ul></li><li><a href="module-webpack_api_security.html">webpack/api/security</a><ul class='methods'><li data-type='method'><a href="module-webpack_api_security.html#.newAccount">newAccount</a></li></ul></li><li><a href="module-webpack_buttonLoader.html">webpack/buttonLoader</a><ul class='methods'><li data-type='method'><a href="module-webpack_buttonLoader.html#.done">done</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.fail">fail</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.load">load</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.success">success</a></li><li data-type='method'><a href="module-webpack_buttonLoader.html#.warning">warning</a></li></ul></li><li><a href="module-webpack_unsavedWork.html">webpack/unsavedWork</a><ul class='methods'><li data-type='method'><a href="module-webpack_unsavedWork.html#.button">button</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.changed">changed</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.destroy">destroy</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.reset">reset</a></li><li data-type='method'><a href="module-webpack_unsavedWork.html#.saved">saved</a></li></ul></li><li><a href="module-webpack_utils.html">webpack/utils</a><ul class='methods'><li data-type='method'><a href="module-webpack_utils.html#.closePage">closePage</a></li><li data-type='method'><a href="module-webpack_utils.html#.distinctKeys">distinctKeys</a></li><li data-type='method'><a href="module-webpack_utils.html#.fetch">fetch</a></li><li data-type='method'><a href="module-webpack_utils.html#.fetchJSON">fetchJSON</a></li><li data-type='method'><a href="module-webpack_utils.html#.fetchStatus">fetchStatus</a></li><li data-type='method'><a href="module-webpack_utils.html#.formatJSON">formatJSON</a></li><li data-type='method'><a href="module-webpack_utils.html#.getCookie">getCookie</a></li><li data-type='method'><a href="module-webpack_utils.html#.loader">loader</a></li><li data-type='method'><a href="module-webpack_utils.html#.materialResponse">materialResponse</a></li><li data-type='method'><a href="module-webpack_utils.html#.openPage">openPage</a></li><li data-type='method'><a href="module-webpack_utils.html#.setCookie">setCookie</a></li><li data-type='method'><a href="module-webpack_utils.html#.thisUser">thisUser</a></li><li data-type='method'><a href="module-webpack_utils.html#.throwError">throwError</a></li><li data-type='method'><a href="module-webpack_utils.html#.urlQuery">urlQuery</a></li><li data-type='method'><a href="module-webpack_utils.html#.uuidv4">uuidv4</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="Caret.html">Caret</a><ul class='methods'><li data-type='method'><a href="Caret.html#destroy">destroy</a></li><li data-type='method'><a href="Caret.html#initialize">initialize</a></li><li data-type='method'><a href="Caret.html#toggle">toggle</a></li></ul></li><li><a href="Logger.html">Logger</a><ul class='methods'><li data-type='method'><a href="Logger.html#debug">debug</a></li><li data-type='method'><a href="Logger.html#done">done</a></li><li data-type='method'><a href="Logger.html#error">error</a></li><li data-type='method'><a href="Logger.html#fetchError">fetchError</a></li><li data-type='method'><a href="Logger.html#log">log</a></li><li data-type='method'><a href="Logger.html#warn">warn</a></li><li data-type='method'><a href="Logger.html#working">working</a></li></ul></li><li><a href="StudentScheduleEditor.html">StudentScheduleEditor</a><ul class='methods'><li data-type='method'><a href="StudentScheduleEditor.html#checkValidity">checkValidity</a></li><li data-type='method'><a href="StudentScheduleEditor.html#generate">generate</a></li><li data-type='method'><a href="StudentScheduleEditor.html#getHasChanged">getHasChanged</a></li><li data-type='method'><a href="StudentScheduleEditor.html#submit">submit</a></li></ul></li><li><a href="Table.html">Table</a></li><li><a href="TeacherScheduleEditor.html">TeacherScheduleEditor</a><ul class='methods'><li data-type='method'><a href="TeacherScheduleEditor.html#checkValidity">checkValidity</a></li><li data-type='method'><a href="TeacherScheduleEditor.html#generate">generate</a></li><li data-type='method'><a href="TeacherScheduleEditor.html#getHasChanged">getHasChanged</a></li><li data-type='method'><a href="TeacherScheduleEditor.html#submit">submit</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">routes/api/account.js</h1>
    

    <!--container.tmpl-->




    <!--source.tmpl-->

    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
Passport-Live is a modern web app for schools that helps them manage passes.
    Copyright (C) 2017  Joseph Hassell

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published
    by the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see &lt;http://www.gnu.org/licenses/>.

email: hi@josephhassell.com
*/
/** 
* Account manipulation APIs
* @module api/accounts
*/
var express = require("express");
var router = express.Router();
var r = require("../../modules/db/index.js");
var cors = require('cors');
var utils = require("../../modules/passport-utils/index.js");
var api = require("../../modules/passport-api/accounts.js"); //("jdsfak"); 
var passport = require("passport");
var config = require("config");
var ssarv = require("ssarv")

var miscApi = require("../../modules/passport-api/index.js");
var securityJS = require("../../modules/passport-api/security.js")

var scheduleApi = require("../../modules/passport-api/schedules.js");
var passApi = require("../../modules/passport-api/passes.js");
var moment = require("moment");

//var for backwards compadability.  neads to be removed later 



router.use(cors());
router.options('*', cors())

function serializeUser(req, res, done) {
    console.log(req.user[0]);
    //REMOVE SECRET INFO LIKE PASSWORDS
    //delete req.user[0].password;
    //req.user = req.user[0];
    req.user = utils.cleanUser(req.user);
    done();
};


//NEW ACCOUNT//



/**
    * Creates A New Account
    * @function handleNewAccount
    * @link module:api/accounts
    * @api POST /api/account/new/:userGroup/
    * @apiparam {userGroup} userGroup - A Usergroup constant defined in the config
    * @apibody {(application/json | application/x-www-form-urlencoded)}
    * @example 
    * &lt;caption>Body Structure (application/json): &lt;/caption>
    * {
    *    "email": "teacher@gmail.com",
    *    "schoolID": "02556",
    *    "graduationYear": 2018,
    *    "password": "123abc",
    *    "passwordVerification": "123abc",
    *    "name": {
    *        "salutation": "Mx.",
    *        "first": "Teacher",
    *        "last": "McTeacher Face"
    *      },
    *    "groupFields": {},
    *    "permissionKey": HJhd38
    * }
    */
    router.post("/new/:userGroup/", utils.rateLimit.publicApiBruteforce.prevent, function handleNewAccount(req, res, next) {
    //Get Params
    
    var email=req.body.email;
    var password=req.body.password;
    var passwordVerification=req.body.passwordVerification;
    var name = req.body.name 
    var groupFields = req.body.groupFields
    var permissionKey = req.body.permissionKey;
    var userGroup = req.params.userGroup;
    var schoolID = req.body.schoolID;
    var graduationYear = req.body.graduationYear;
    console.log(userGroup);
    //Checks to see if the account needs a verification key
    var promise = new Promise(function(resolve, reject) {
        if (config.has('userGroups.' + userGroup)) {
            if(config.get('userGroups.' + userGroup + ".verifyAccountCreation")) {
                if(!permissionKey) {
                    var err = new Error("Permission Key Required");
                        err.status = 403;
                        reject(err);
                }
                securityJS.checkPermissionKeyValidity(securityJS.permissionKeyType.NEW_ACCOUNT, permissionKey).then((data) => {
                    //CHeck  if usergroup is present
                    if(!data) {
                        var err = new Error("Invalid Key");
                        err.status = 400;
                        return reject(err);
                    } else if(!data.permissions.userGroups.includes(userGroup)) {
                        var err = new Error("Permission Needed");
                        err.status = 403;
                        return reject(err);
                    } else {
                        securityJS.keyUsed(securityJS.permissionKeyType.NEW_ACCOUNT, permissionKey).then(() => {return resolve();}).catch(err => reject(err));
                    }
                }).catch(err => reject(err));
            } else {
                resolve();
            }
        } else {
            var err = new Error("Usergroup Not Found");
            err.status = 404;
            reject(err);
        }
    })

    promise.then(function(result) {
        if(password != passwordVerification) {
            res.sendStatus(422);
        } else {
            api.createAccount({userGroup: userGroup, name: name, email: email, password: password, schoolID: schoolID, graduationYear: graduationYear}).then(function(resp) {
                res.status(201).send(resp)
            }).catch((err, trans) => {
                return next(err)
            });
        }
    }, function(err) {
        next(err);
    })
});

/**
    * Searches Accounts
    * @function searchAccounts
    * @link module:api/accounts
    * @api GET /api/account/
    * @apiquery {(string|undefined)} id - The id of the user. A Primary Key. Uses getAll.
    * @apiquery {(string|undefined)} email
    * @apiquery {(userGroup|undefined)} userGroup
    * @apiquery {(string|undefined)} name - If a string, any other name query (name_salutation, name_first, name_last) will be ignored 
    * @apiquery {(string|undefined)} name_salutation - User's prefix/salutation
    * @apiquery {(string|undefined)} name_first - User's given name
    * @apiquery {(string|undefined)} name_last - User's family name
    * @apiquery {(string|undefined)} schoolID
    * @apiquery {(number|undefined)} graduationYear - Will be typecast
    * @apiresponse {Object[]} Returnes the safe info
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    */
router.get("/", passport.authenticate('jwt', { session: false}), function searchAccounts(req, res, next) {
    if(!req.query.name) {
        if(req.query.name_salutation || req.query.name_first || req.query.name_last) {
            req.query.name = {};
            if(req.query.name_salutation) {
                req.query.name.salutation = req.query.name_salutation;
            }
            if(req.query.name_first) {
                req.query.name.first = req.query.name_first;
            }
            if(req.query.name_last) {
                req.query.name.last = req.query.name_last;
            }
        }
    }
    if(typeof req.query.graduationYear === "string") {
        req.query.graduationYear = parseInt(req.query.graduationYear);
    }
    delete req.query.name_salutation;
    delete req.query.name_first;
    delete req.query.name_last;
    api.get(req.query).then((users) => {
        return res.json(users)
    }).catch((err) => {
        return next(err);
    })
})

/**
    * GETs accounts by id
    * @function handleGetAccountsById
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/id/:id
    * @apiparam {uuid} id - The id of the user
    * @apiresponse {json} Returnes the safe info
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    */
//GET FULL ACCOUNT (WITH SAFTEY REMOVAL)//
router.get("/id/:id/", passport.authenticate('jwt', { session: false}), function handleGetAccountsById(req, res, next) {
    var id = req.params.id;
    api.getUserByID(id, function(err, data) {
        if(err) {
            return next(err) 
        }
        res.json(utils.cleanUser(data));
    })
});

/**
    * GETs accounts by email
    * @function getAccountsByEmail
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/email/:email/
    * @apiparam {string} email - The Email of the user
    * @apiresponse {json} Returnes the safe info
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    * @todo KILL OFF WHEN AUTOCOMPLETE WITH IDs ARE ADDED.  PRIVACY RISK!
    */
router.get("/email/:email/", passport.authenticate('jwt', { session: false}), function getAccountsByEmail(req, res, next) {
    var email = req.params.email;
    api.getAccountByEmail(email, function(err, data) {
        if(err) {
            return next(err) 
        }
        var resp = [];
        if(data.length &lt;=0) {
            res.json(resp);
        }
        for(var x = 0; x &lt; data.length; x++) {
            resp.push(utils.cleanUser(data[x]));
            if(x >= data.length-1) {
                res.json(resp);
            }
        }
        
    })
});


/**
    * GETs all accounts by usergroup
    * @function handleGetAccountsByUserGroup
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/userGroup/:userGroup/
    * @apiparam {userGroup} userGroup - A Usergroup constant defined in the config
    * @apiresponse {json} Returns in a json object from the database, the name object, the email, the userGroup, and ID
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    */
router.get("/userGroup/:userGroup/", passport.authenticate('jwt', { session: false}), function handleGetAccountsByUserGroup(req, res, next) {
    var userGroup = req.params.userGroup;

    
    api.getUserGroupAccountByUserGroup(r.conn(), userGroup, function(err, acc) {
        if(err) {
            next(err);
        }
        console.log(acc)
        var ret = [];
        for (var i = 0; i &lt; acc.length; i++) {
            /*var safeUser = {
                name: acc[i].name, 
                email: acc[i].email, 
                userGroup: acc[i].userGroup, 
                id: acc[i].id, 
                groupFields: acc[i].groupFields[userGroup]
                
            }*/
            ret.push(utils.cleanUser(acc[i]));
        }
        res.json(ret);
    }); 
});


/**
    * GETs accounts by name and usergroup
    * @function handleGetAccountsByNameAndUserGroup
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/userGroup/:userGroup/name/:name/
    * @apiparam {userGroup} userGroup - A Usergroup constant defined in the config
    * @apiparam {string} name - A user's name.  Can be in any name format.
    * @apiresponse {json} Returns in a json object from the database, the name object, the email, the userGroup, ID, and some group fields
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    */
router.get("/userGroup/:userGroup/name/:name", passport.authenticate('jwt', { session: false}), function handleGetAccountsByNameAndUserGroup(req, res, next) {
    var userGroup = req.params.userGroup;
    var name = req.params.name;

    
    api.getUserGroupAccountByName(r.conn(), name, userGroup, function(err, acc) {
        if(err) {
            return next(err);
        } else if(acc == null) {
            return res.json([]) 
        }
        
        var ret = [];
        if(acc.length &lt;= 0) {
            return res.json([]);
        }
        for (var i = 0; i &lt; acc.length; i++) {
            ret.push(utils.cleanUser(acc[i]))
            if(i>= acc.length -1) {
                return res.json(ret);
            }
        }
    }); 
});

/**
    * GETs accounts by name
    * @function handleGetAccountsByName
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/name/:name/
    * @apiparam {string} name - A user's name.  Can be in any name format.
    * @apiresponse {json} Returns in a json object from the database, the name object, the email, the userGroup, ID, and some group fields
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    */
router.get("/name/:name", passport.authenticate('jwt', { session: false}), function handleGetAccountsByName(req, res, next) {
    var name = req.params.name;

    
    api.getUserGroupAccountByName(r.conn(), name, ".", function(err, acc) {

        if(err) {
            return next(err);
        } else if(acc == null) {
            return res.json([]) 
        }
        
        var ret = [];
        if(acc.length &lt;= 0) {
            return res.json([]);
        }
        for (var i = 0; i &lt; acc.length; i++) {
            ret.push(utils.cleanUser(acc[i]))
            if(i>= acc.length -1) {
                return res.json(ret);
            }
        }
        
    }); 
});

/**
    * GETs accounts That have hasClasses option set to true in the configs
    * @function getAccountsWithClasses
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/hasClasses
    * @apiresponse {json} Returns in a json object from the database, the full account
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    */
router.get("/hasClasses/", passport.authenticate('jwt', { session: false}), function getAccountsWithClasses(req, res, next) {
    var uG = config.get('userGroups');
    var valKeys = [];
        var i = 0;
        for (var key in uG) {

            
            console.log(i)
            if (uG.hasOwnProperty(key) &amp;&amp; config.has('userGroups.' + key + '.hasClasses') &amp;&amp; config.get('userGroups.' + key + '.hasClasses') == true) {
               
               valKeys.push(key);
            } 
            
            if(i >= Object.keys(uG).length-1) {
                recurrConcatHasClass(valKeys, [], function(err, finalArr) {
                    if(err) {
                        return next(err);
                    }
                    return res.json(finalArr)
                })                
            }
            i++;
        }
});

function recurrConcatHasClass(keys, finalArr, done) {
    if(keys.length &lt;= 0) {
        return done(null, finalArr);
    }
    api.getUserGroupAccountByUserGroup(r.conn(), keys[0], function(err, acc) {
        if(err) {
            return done(err);
        }
        var clean = [];
        //skip usergroup
        if(acc.length &lt;= 0) {
            return recurrConcatHasClass(keys.slice(1), finalArr, done);
        }
        for(var x = 0; x &lt; acc.length; x++) {
            clean.push(utils.cleanUser(acc[x]));
            if(x >= acc.length-1) {
                finalArr = finalArr.concat(clean);
                return recurrConcatHasClass(keys.slice(1), finalArr, done);
            }
        }
        
    });
}

//Special dashboard specific gets//


//MAKE CHANGES.  REQUIRES AUTH AND PERMISSION.  

/**
    * Updates usergroup specific data.
    * REQUIRES JWT Authorization in headers.
    * account must be in the usergroup for it to update
    * Check Example usergroup model for more examples 
    * @function handleUpdateAccountGroupFieldsByUser
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api PATCH /api/account/groupfields/
    * @apiresponse {json} Returns rethink db action summery
    * @example 
    * &lt;caption>Body Structure (application/json): &lt;/caption>
    * {
    *     "id": 123456, //school id
    *     "student": { //any dashboard name
    *        "periodSchedule": {
    *                "a": {
    *                    "teacherID": "46545645-456-4-45645-45646" //id from database
    *                },
    *                "b": {
    *                    "teacherID": "456486-5190814-4567" //id from database
    *                },
    *                "lunch1": {
    *                    "teacherID": null, //if teacherID is null or undefined, passport expects data about where the period takes place
    *                    "room": "Cafeteria"
    *                }
    *            }, 
    *         "settings": {
    *             "test": false
    *          }
    *      }
    *  }
    * 
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    */
router.patch("/groupfields/", passport.authenticate('jwt', { session: false}), function handleUpdateAccountGroupFieldsByUser(req, res, next) {
    var updateDoc = req.body;

     api.updateAccountGroupFieldsByID(r.conn(), req.user.id, updateDoc, function(err, data) {
        if(err) {
            return next(err);
        }
        return res.send(data);
    })
});




/* GETs All account schedule types for an account
    * If you dont give an ID, the user in the JWT will be assumed.
    * @function getAllSchedules
    * @deprecated
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/schedule/{:id}
    * @apiparam {string} id - A user's ID.
    * @apiresponse {json} Returns the schedule
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
*/

/*router.get(['/schedule', '/schedule/:id/'], passport.authenticate('jwt', { session: false}), function getAllSchedules(req, res, next) {
    if(!req.params.id) {
        req.params.id = req.user.id;
    }
    var prom = [];

    prom.push(new Promise(function(resolve, reject) {
        api.getStudentSchedule(req.params.id, function(err, data) {
            if(err &amp;&amp; err.status != 404) {
                return reject(err);
            }
            
            return resolve(data)
        })
    }))

    prom.push(new Promise(function(resolve, reject) {
        api.getTeacherSchedule(req.params.id, function(err, data) {
            if(err &amp;&amp; err.status != 404) {
                return reject(err);
            }
            
            return resolve(data)
        })
    }))

    Promise.all(prom).then(function(arr) {
        res.json({studentType: arr[0], teacherType: arr[1]});
    }).catch(function(err) {
        return next(err)
    });
});*/

/** GETs Current Period Location regardless of dashboard
    * @function getCurrentLocation
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/location/datetime/:dateTime/id/:id/
    * @apiparam {string} id - A user's ID.
    * @apiparam {string} dateTime - An ISO dateTime string WITH timezone.
    * @apiresponse {json} Returns Both teacher and studnet locations 
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
*/

router.get('/location/datetime/:dateTime/id/:id/', passport.authenticate('jwt', { session: false}), function getCurrentLocation(req, res, next) {
    var promises = [];
    if(!req.params.id) {
        var err = new Error("ID Required");
        err.status = 400;
        return next(err)
    }
    scheduleApi.getActivePeriodsAtDateTime(req.params.dateTime, function(err, currentSchedules) {
        if(err) {
            return next(err);
        }
        if(currentSchedules.length &lt;=0 ) {
            return res.json({})
        }
        var forPeriods = currentSchedules.map(function(x) {
            return x.period
        })
        console.log(forPeriods)
        //get user's location 
        promises.push(getPeriodsInScheduleThenReformat(req.params.id, forPeriods, "schedule"));

        //Check for Passes 
        promises.push(new Promise(function(doneResolve, doneReject) {
            passApi.flexableGetPasses(req.params.id, "migrator", moment(req.params.dateTime).utc().format("Y-MM-DD"), moment(req.params.dateTime).add(1, "days").utc().format("Y-MM-DD"), forPeriods, function(err, passes) {
                if(err) {
                    return doneReject(err);
                }
                var passPromise = [];
                if(passes.length &lt;= 0) {
                    return doneResolve({pass: null})
                }
                console.log(passes.length)
                for(var x = 0; x &lt; passes.length; x++) {
                    if(!passes[x].toPerson || !passes[x].toPerson.schedules) {
                        passPromise.push(new Promise(function(resolve, reject) {
                            return resolve({pass: null})
                        }));
                        
                    } else {
                        if(!passes[x].toPerson.schedules.teacher &amp;&amp; !passes[x].toPerson.schedules.student) {
                        //console.log(passes[x].toPerson)
                            passPromise.push(new Promise(function(resolve, reject) {
                                return resolve({pass: null})
                            }));
                        } else {
                            passPromise.push(getPeriodsInScheduleThenReformat(passes[x].toPerson.id, forPeriods, "pass", {passId: passes[x].id, toPerson: passes[x].toPerson}));
                        }
                    }
                    
                    

                    if(x >= passes.length - 1) {
                        //console.log("hello")
                        Promise.all(passPromise).then(function(data) {
                            var finalPassData = {};
                            var studentPassArr = [];
                            var teacherPassArr = [];
                            
                            if(data.length &lt;= 0) {
                                return doneResolve({});
                            }
                            for(var i = 0; i &lt; data.length; i++) {
                                if(data[i].pass &amp;&amp; data[i].pass.student) {
                                   studentPassArr= studentPassArr.concat(data[i].pass.student)
                                }

                                if(data[i].pass &amp;&amp; data[i].pass.teacher) {
                                    teacherPassArr = teacherPassArr.concat(data[i].pass.teacher);
                                }

                                if(i >= data.length -1 ) {

                                    console.log(finalPassData, "tru")
                                    return doneResolve({pass: {student: studentPassArr, teacher: teacherPassArr}})
                                }
                            }
                            
                        }).catch(function(err) {
                            return doneReject(err)
                        });
                    }
                }
                


                
            });
        }));

        Promise.all(promises).then(function(data) {

            return res.json(Object.assign({}, data[0], data[1]))
        }).catch(function(err) {
            return next(err)
        });
    })
});

function getPeriodsInScheduleThenReformat(userID, forPeriods, scheduleKeyName, extraData) {
    return new Promise(function(doneResolve, doneReject) {
        var promises = [];
         api.getSpecificPeriods(userID, forPeriods, function(err, periodData) {
            if(err) {
                return doneReject(err)
            }
            //return res.json(periodData)
            if(!periodData) {
                var err = new Error("getSpecificPeriods did not return anything ");
                err.status = 500;
                return doneReject(err)
            }
            //Get student.schedule return data
            var scheduleLocationReturn = {};
            scheduleLocationReturn[scheduleKeyName] = {};
            promises.push(new Promise(function(resolve, reject) {
                if(periodData.student) {
                    //scheduleLocationReturn[scheduleKeyName].student = [];
                    var pS = periodData.student;
                    var tS = [];
                    if(pS.length &lt;=0) {
                        return resolve();
                    }
                    for(var x = 0; x &lt; pS.length; x++) {
                        if(pS[x].periodData) {
                            //check if they have a teacher or not
                            if(pS[x].periodData.teacher) {
                                //check if the teacer has a schedule set
                                tS.push(Object.assign({},{period: pS[x].period}, pS[x].periodData, extraData))
                            } else {
                                tS.push(Object.assign({},{period: pS[x].period, teacher: null}, extraData))
                            }
                        }
                        //end
                        if(x >= pS.length - 1) {
                            scheduleLocationReturn[scheduleKeyName].student = tS
                            return resolve();
                        }
                    }
                } else {
                    return resolve();
                }
            }));

            //get teacher.schedule 
            promises.push(new Promise(function(resolve, reject) {
                if(periodData.teacher) {
                    //scheduleLocationReturn[scheduleKeyName].teacher = [];
                    var pT = periodData.teacher;
                    var tT = [];
                    if(pT.length &lt;=0) {
                        return resolve();
                    }
                    for(var x = 0; x &lt; pT.length; x++) {
                        if(pT[x].periodData) {
                            tT.push(Object.assign({},{period: pT[x].period}, pT[x].periodData, extraData))
                        }
                        if(x >= pT.length-1) {
                            scheduleLocationReturn[scheduleKeyName].teacher = tT;
                            return resolve();
                        }
                    }
                    
                } else {
                    return resolve();
                }
            }));

            Promise.all(promises).then(function(data) {
                return doneResolve(scheduleLocationReturn)
            }).catch(function(err) {
                return doneReject(err)
            });
        });

    });
}

/**/

/** Checks if an accuunt is missing required fields by that dashboard  
    * @function studentCheckIfIncomplete
    * @link module:api/accounts
    * @param {request} req
    * @param {response} res
    * @param {nextCallback} next
    * @api GET /api/account/incomplete/dashboard/student
    * @apiresponse {json} Returns missing fields
    * @returns {callback} - See: {@link #params-params-nextCallback|&lt;a href="#params-nextCallback">Callback Definition&lt;/a>} 
    * @todo SSARV
*/
router.get('/incomplete/dashboard/student', passport.authenticate('jwt', { session: false}), function studentCheckIfIncomplete(req, res, next) {
    //todo 
});



/** Updates user Password   
    * @function updateUserPassword
    * @link module:api/accounts
    * @param {request} req
    * @property {Object} body
    * @property {String} body.current - The user's current password.
    * @property {String} body.new - The user's new password.
    * @property {String} body.newVerify - body.new again.
    * @param {response} res
    * @param {nextCallback} next
    * @api PATCH /api/account/password/
    * @apiresponse {json} Status Code
    * @returns {callback} - See: {@link nextCallback} 
*/
router.patch("/password/", passport.authenticate('jwt', { session: false}), function updateUserPassword(req, res, next) {
    if(typeof req.body.current === "string" &amp;&amp; typeof req.body.new === "string" &amp;&amp; typeof req.body.newVerify === "string") {
        if(req.body.new == req.body.newVerify) {
            api.changePassword(req.user.id, req.body.current, req.body.new).then(function(trans) {
                return res.send(trans);
            }).catch(function(err) {
                return next(err);
            })
        } else {
            var err = new Error("Passwords Do Not Match")
            err.status = 400;
            return next(err);
        }
        
    } else {
        var err = new Error("Body Malformed")
        err.status = 400;
        return next(err);
    }
});

module.exports = router;

/**
 * A name of a userGroup defined in the configs
 * @typedef {string} userGroup
 */
 /**
 * The request object 
 * @typedef {object} request
 */

  /**
 * The response object sent to the requester 
 * @typedef {object} response
 */


 /**
 * @callback nextCallback
 * @param {object} err - Any errors that may arrise should be passed through here
 */</code></pre>
        </article>
    </section>





</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Jan 22 2018 04:05:16 GMT+0000 (UTC) using the LOKE theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
